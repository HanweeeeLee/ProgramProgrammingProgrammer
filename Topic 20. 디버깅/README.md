# Topic 20. 디버깅

디버깅에 관한 몇몇 문제를 살펴보고, 버그를 찾아내는 일반적인 전략을 몇가지 알아보자

## 디버깅의 심리
디버깅은 단지 문제 풀이일 뿐이라는 사실을 받아들이고, 그런 마음으로 공략하라.

## 디버깅 사고방식
> 디버깅 제1법칙 '당황하지 말라'

겉으로 드러난 특정한 증상만 고치려고 하지 말고, 항상 문제의 근본 원인을 찾으려고 노력하라.   

## 실마리 찾기
버그를 살펴보기 전에 우선 작업중인 코드가 경고 없이 깨끗하게 빌드되는지부터 확인하라.  
컴파일러의 경고 수준을 최고로 높게 맞추고 컴퓨터가 찾도록 해야한다.  
컴퓨터가 대신 찾아 줄 수 있는 문제를 우리가 찾느라 시간을 허비하지 말고 우리는 더 어려운 문제에 집중해야 한다.  

## 디버깅 전략

### 버그 재현하기
버그를 고치는 첫걸음으로 가장 좋은 것은 그 버그를 재현할 수 있게 만드는 것이다.  
디버깅의 가장 중요한 규칙은 다음과 같다.  
> 코드를 고치기 전 실패하는 테스트부터

## 미지의 세계에 온 프로그래머

### 이상한 결과
프로그램이 죽는 것이 아니라 결과가 이상한 상황이라면 어떻게 해야할까?  
디버거를 붙인 다음 실패하는 테스트를 이용하여 문제를 재현하라.  
가끔은 긴 스택 트레이스를 만날 때가 있다. 이런 때는 스택 프레임을 일일이 조사하는 것보다 '이진 분할'을 하는게 좋다.  

### 입력값에 따라 바뀜
평소에 훌륭하게 동작하던 프로그램이 갑자기 특정한 데이터 세트만 들어오면 죽어버리는 경험이 있을것이다.  
이런 때는 프로그램이 죽은 지점부터 거꾸로 추적해 갈 수도 있다. 하지만 데이터에서 시작하는 것이 더 쉬운 경우도 있다.  
데이터 세트를 복사한다음, 개발 환경에서 실행시킨 애플리케이션에 입력해서 여전히 프로그램이 죽는지 확인하라.  
그래도 프로그램이 죽는다면, 이진분할을 활용해서 정확히 어떤 값이 문제인지 찾아내라.  

### 릴리스 사이에서 발생한 문제
소프트웨어를 실제 서비스에 배포한다. 일주일전에는 괜찮았던 코드에서 언제부터 있었는지 모를 버그가 나타났다.  
정확하게 어떤 변경사항 때문에 버그가 발생했는지 알아내려면 이진분할을 사용하자.  

## 이진 분할
이분 탐색, 이진 검색 등으로도 부르는 방법이다.  
만약 거대한 스택 트레이스가 눈앞에 있는데 이 중 정확히 어떤 함수에서 문제가 되는 값을 엉망으로 만들었는지 찾아내려 한다.  
검색을 시작하기 위해 중간즈음에서 스택 프레임을 하나 골라서 값이 정상인지 확인한다.  
정상이라면 위의 프레임들을 확인하고 아니라면 아래의 프레임을 확인한다. 그리고 이것을 반복한다.  
특정 데이터 세트에 대해서만 버그가 나타나는 경우에도 마찬가지로 이진 분할을 사용할 수 있다.  
데이터 세트를 둘로 나누고 각각을 프로그램에 넣었을 때 문제가 발생하는지 살펴보라.  
문제가 발생하는 가장 작은 데이터 세트를 만들때까지 반복하라.  
현재 릴리스에서 예전 릴리스에는 없던 버그가 발생한다면, 현재 릴리스에서 실패하는 테스트를 만들어라.  
문제가 없었던 버전중 가장 최근 버전과 현재 버전 사이에서 중간정도에 위치한 릴리스를 골라라.  
테스트를 수행한 후, 결과에 따라 어느쪽을 탐색할지 고르면 된다.  

### 로깅과 트레이싱
코드 깊숙히 파고 들어가기 위해 트레이싱 구문을 사용할 수 있다.  
트레이싱 구문으로 남기는 메세지는 규칙적이고 일관된 형식이어야 한다. 메세지를 자동으로 분석해야 할 수도 있기 때문이다.  
예를 들어 자원 찾기 위해 짝이 맞지 않는 open과 close를 추적해보고 싶다면, 호출할 때마다 메세지를 로그파일로 남겨둔다.  
로그 파일을 텍스트 처리 도구와 셸 명령어로 처리하면 문제를 일으키는 open을 쉽게 찾아낼 수 있다.  

### 고무 오리
문제의 원인을 찾는 매우 단순하지만 꽤 유용한 기법으로 그냥 누군가에게 문제를 설명하는 방법이 있다.  
상대방은 욕조안에서 고무오리가 까딱거리듯 여러분의 어깨너머로 화면을 보며 머리를 끄덕이게 된다.  
누군가에게 문제를 설명하게 되면 혼자 코드를 살펴볼때는 당연히 여기고 지나갈 것을 명시적으로 이야기해야 한다.  
이런 가정 몇가지를 입밖에 내면 문제에 대한 새로운 통찰을 불현듯 얻을수도 있다.  

### 소거법
OS나 컴파일러 혹은 외부 제품에 버그가 있을 수도 있다. 하지만 처음부터 그런 생각을 하지는 마라.  
개발하고 있는 애플리케이션 코드에 버그가 존재할 가능성이 훨씬 더 크다.  
대개 애플리케이션 코드가 라이브러리를 잘못 호출하고 있다고 가정하는 편이 라이브러리 자체에 문제가 있다고 가정하는 것보다 낫다.  
만약 여러분이 '단 하나'만 변경했는데 시스템이 작동을 멈춘다면 설사 아무 관련이 없어보여도 십중팔구 변경한 그 하나에 책임이 있다.  

## 놀라운 구석
뭔가 잘못될 때 놀라는 정도는 실행되는 코드에 갖는 신뢰와 믿음의 정도에 비례한다.  
그렇기에 예상치 못한 놀라운 실패를 대면했을 때 자신이 세운 가정이 적어도 하나는 잘못되었다는 것을 받아들여야 한다.  
버그와 관련된 루틴이나 코드가 제대로 작동하는걸 안다고 해서 대충 얼버무리고 지나치지말고 증명하라.  
놀라운 버그와 마주쳤을 때 단순히 그걸 고치는 것을 넘어서 버그를 미리 잡을수 있도록 단위테스트나 다른 테스트를 수정할 필요가 있는지 고민해 보라.  
마지막으로 버그가 누군가의 잘못된 가정으로 발생했다면 이 문제를 전체 팀과 함께 토론하라. 한 사람이 오해 했다면 다른 사람들도 그럴 수 있다.  

## 디버깅 체크 리스트
 - 보고된 문제가 내재하는 버그의 직접적 결과인가 아니면 단순히 증상일 뿐인가?
 - 버그가 정말로 여러분이 사용하는 프레임워크에 있나? OS에? 아니면 여러분 코드에 있나?
 - 이 문제를 동료에게 상세히 설명한다면 어떻게 말하겠는가?
 - 의심 가는 코드가 단위 테스트를 통과한다면 테스트는 충분히 갖춰진 것인가? 이 데이터로 테스트를 돌리면 무슨 일이 생기는가?
 - 이 버그를 야기한 조건이 시스템의 다른 곳에도 존재하는가? 다른 버그가 유충 단계에서 성충이 될 날만 기다리고 있는 것은 아닌가?
