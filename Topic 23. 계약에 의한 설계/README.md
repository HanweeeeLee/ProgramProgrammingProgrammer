# Topic 23.계약에 의한 설계
컴퓨터 시슨템을 다루는 것은 어렵다. 정직한 거래를 보장하는 최선의 해법 중 하나는 '계약'이다.  
계약은 자신과 상대편의 권리 및 책임을 정의한다. 그뿐만 아니라 한쪽이 계약을 어겼을 경우의 대응도 계약 사항에 포함된다.  
소프트웨어 모듈이 서로 소통하는 것을 돕기 위해 동일한 개념을 사용할 수 있을까? 가능하다.

## DBC
DBC는 '계약에 의한 설계(Design by Contract)'라는 개념이다.  
DBC는 단순하지만 강력한 기법으로 프로금의 정확성을 보장하기 위해 소프트웨어 모듈의 권리와 책임을 문서화하고 합의하는데 초점을 맞춘다.  
정확한 프로그램이란 자신이 하는 일이라고 주장하는 것보다 많지도 적지도 않게 딱 그만큼만 하는 프로그램이다.  
이 주장을 문서화하고 검증하는것이 DBC의 핵심이다.  
소프트웨어 시스템의 모든 함수와 메서드는 뭔가를 한다.  
그 뭔가를 시작하기 전에 해당 함수는 세상의 상태에 대해 어떤 전제 조건을 갖고 있을테고, 루틴이 끝난 후에는 세상의 상태가 어떠할 것이라고 선언할 수 있을 것이다.  
이런 전제와 선언을 다음과 같이 설명한다.

### 선행조건
루틴이 호출되기 위해 참이어야 하는것, 즉 루틴의 요구사항이다.  
루틴의 선행조건이 위반된 경우에는 호출되어서는 안 된다. 제대로 된 데이터를 전달하는 것은 호출하는 쪽의 책임이다.

### 후행조건
루틴이 자기가 할 것이라고 보장하는 것. 즉, 루틴이 완료되었을 때 세상의 상태다.  
루틴에 후행 조건이 있다는 것은 곧 루틴이 종국에는 종료될 것이라는 걸 의미한다. 무한반복은 허용되지 않는다.

### 클래스 불변식
호출자의 입장에서 볼 떄는 이 조건이 언제나 참인 것을 클래스가 보장한다.  
루틴의 내부 처리 도중에는 불변식이 참이 아닐 수도 있지만, 루틴이 끝나고 호출자로 제어권이 반환되는 시점에는 불변식이 참이 되어야 한다.  
루틴과 그 루틴을 호출하려는 코드 간의 계약은 다음과 같다.  
> 만약 호출자가 루틴의 모든 선행 조건을 충족한다면 해당 루틴은 종료 시 모든 후행 조건과 불변식이 참이 되는 것을 보장한다.

만약 계약 당사자 중 어느 한쪽이라도 이 계약 내용을 지키지 못하면 양측이 동의한 내용에 따라 해결 방안이 실행된다.  
예외가 발생할 수도 있고 아니면 프로그램을 종료시킬 수도 있다. 무슨일이 벌어지든지 확실한 점은 계약에 부응하지 못하는 것은 버그라는 것이다.  
이런 개념을 더 잘 지원하는 언어들이 있다. 예를 들어 클로저(Clojure)는 스펙(spec) 라이브러리에 기반하여 선행 및 후행 조건 뿐 아니라 더 포괄적인 도구를 제공한다.

### 클래스 불변식과 함수형 언어
한가지 짚고 넘어가야할 것이 있다. '클래스 불변식' 이라는 용어가 진짜로 의미하는 것은 상태(state)다.  
객체지향 언어에서 상태는 클래스의 인스턴스와 관련이 있다. 하지만 다른 언어에도 마찬가지로 상태가 있다.  
함수형 언어에서는 보통 상태를 함수에 넘긴 후 바뀐 상태를 결과로 받는다. 불변식이라는 개념은 이런 상황에서도 똑같이 유용하다.

## DBC 구현
코드를 작성하기 전, 유효한 입력범위가 무엇인지, 경계 조건이 무엇인지, 루틴이 뭘 전달한다고 약속하는지 등을 나열하는 것만으로도 더 나은 소프트웨어를 작성하는데에 엄청난 도움이 된다.  
코드에서 DBC를 지원하지 않는 언어에서는 이정도가 최선일 것이지만 그다지 나쁜일은 아니다.  
DBC는 결국 설계 기법이다. 자동 검사가 없더라도 계약을 코드에 주석이나 단위 테스트로 넣어둘 수도 있고, 여전히 실질적인 소득이 있다.

### 단정문
이런 가정들을 문서화하는것은 훌륭한 출발이 되지만, 컴파일러가 대신 계약을 검사하도록 한다면 더 도움이 될것이다.  
몇몇 언어에서는 조건문을 실행 시점에 확인하는 '단정문'을 사용해 부분적으로나마 흉내 낼 수 있다.  
객체 지향 언어의 경우 상속 계층을 따라 단정문이 밑으로 전파되도록 할 수 없을 것이다. 따라서 새 코드에 수작업으로 일일이 복사해 넣어야 한다.  
또한 일반적인 런타임 시스템과 라이브러리가 계약을 지원하도록 설계되지 않았기 때문에, 이런 코드를 호출 시 검사가 이루어지지 않는다.

## DBC와 일찍 멈추기
DBC는 "일찍 작동을 멈춰라" 라는 개념과 잘 어울린다.  
단정문이나 DBC 방식을 사용하여 선행 조건과 후행 조건, 불변식을 검증하면 더 일찍 멈추고, 문제에 대한 보다 정확한 정보를 알려줄 수 있을 것이다.  
문제를 찾고 원인을 밝히기 위해서는 사고가 난 지점에서 일찍 멈추는 것이 유리하다.  

## 의미론적 불변식
'의미론적 불변식'을 사용하면 일종의 '철학적 계약'인 절대 어겨서는 안 되는 요구 사항을 표현할 수 있다.  
의미론적 불변식은 무언가가 품은 진짜 의미의 중심이 되어야 하며, 훨씬 역동적으로 변하는 비즈니스 규칙처럼 일시적인 정책에 영향을 받으면 안된다.  
불변식의 자격이 있는 요구 사항을 찾았다면 여러분이 작성하는 모든 문서에 잘 드러나도록 만들어라.  
이것은 모든 시스템 사용자와 맺는 계약이며 동작에 대한 우리의 보증이다.  

## 동적 게약과 에이전트
지금까지 계약이 고정불변의 명세라고 가정하고 이야기했다. 하지만 자율 에이전트의 무대에서라면 이야기는 달라진다.  
'자율'의 정의에 따르면 에이전트는 자신이 따르길 원치 않는 요구를 거절하거나 계약을 재협상할 자유가 있다.  
에이전트 기술에 의존하는 어떤 시스템이건 계약의 합의가 결정적으로 중요하다는 점은 분명하다. 계약 내용이 매번 동적으로 생성되더라도 마찬가지다.  
그러니 나중에 소프트웨어를 설계하게 되면 계약 역시 설계하도록 하라.
